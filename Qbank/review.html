<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review Questions - Qbank Admin</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .job-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .job-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: var(--gray-50);
      cursor: pointer;
      transition: var(--transition);
    }

    .job-header:hover {
      background: var(--gray-100);
    }

    .job-info {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .job-subject-icon {
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      font-size: 1.5rem;
    }

    .job-details h4 {
      margin: 0 0 4px;
    }

    .job-meta {
      font-size: 0.85rem;
      color: var(--gray-500);
    }

    .job-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .job-content {
      display: none;
      border-top: 1px solid var(--gray-200);
    }

    .job-content.expanded {
      display: block;
    }

    .questions-list {
      padding: 20px;
    }

    .question-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .question-checkbox input {
      margin-top: 4px;
      width: 20px;
      height: 20px;
    }

    .question-edit-btn {
      opacity: 0;
      transition: var(--transition);
    }

    .question-card:hover .question-edit-btn {
      opacity: 1;
    }

    .edit-form textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-family: inherit;
      font-size: 0.95rem;
      resize: vertical;
    }

    .edit-form input {
      padding: 8px 12px;
      border: 1px solid var(--gray-300);
      border-radius: var(--radius);
      font-size: 0.9rem;
    }

    .option-edit-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .option-edit-row input[type="text"] {
      flex: 1;
    }

    .bulk-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      background: var(--gray-50);
      border-top: 1px solid var(--gray-200);
    }

    .select-all-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>
</head>
<body>
  <header id="nav-header"></header>

  <div class="page-wrapper">
    <div class="page-content">
      <div class="page-header">
        <h1 class="page-title">
          <span class="page-title-icon">üëÅÔ∏è</span>
          Review Questions
        </h1>
        <p class="page-subtitle">Review, edit, and approve generated questions</p>
      </div>

      <!-- Filters -->
      <div class="card" style="margin-bottom: 24px;">
        <div class="card-body" style="padding: 16px 24px;">
          <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
            <div class="form-group" style="margin: 0;">
              <select id="statusFilter" class="form-select" style="width: auto;">
                <option value="pending">Pending Review</option>
                <option value="reviewed">Reviewed (Ready to Insert)</option>
                <option value="all">All Jobs</option>
              </select>
            </div>
            <div class="form-group" style="margin: 0;">
              <select id="subjectFilter" class="form-select" style="width: auto;">
                <option value="all">All Subjects</option>
              </select>
            </div>
            <button class="btn btn-secondary" onclick="loadJobs()">üîÑ Refresh</button>
          </div>
        </div>
      </div>

      <!-- Jobs List -->
      <div id="jobsContainer">
        <div class="qbank-loader">
          <div class="loader-spinner"></div>
          <p class="loader-message">Loading review queue...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal Template -->
  <div id="editModal" class="qbank-modal-overlay" style="display: none;">
    <div class="qbank-modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Edit Question</h3>
        <button class="modal-close" onclick="closeEditModal()">√ó</button>
      </div>
      <div class="modal-body" id="editModalBody">
        <!-- Form loaded dynamically -->
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveQuestionEdit()">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="./shared.js"></script>
  <script>
    let user = null;
    let jobs = [];
    let currentEditJob = null;
    let currentEditIndex = null;

    async function init() {
      user = await Qbank.requireAuth();
      if (!user) return;

      Qbank.renderNavHeader();

      // Populate subject filter
      const subjects = await Qbank.fetchSubjects();
      const subjectFilter = document.getElementById('subjectFilter');
      subjects.forEach(s => {
        const option = document.createElement('option');
        option.value = s.id;
        option.textContent = `${Qbank.getSubjectEmoji(s.id)} ${s.name}`;
        subjectFilter.appendChild(option);
      });

      // Add filter event listeners
      document.getElementById('statusFilter').addEventListener('change', loadJobs);
      document.getElementById('subjectFilter').addEventListener('change', loadJobs);

      await loadJobs();
    }

    async function loadJobs() {
      const container = document.getElementById('jobsContainer');
      Qbank.showLoader(container, 'Loading review queue...');

      try {
        const statusFilter = document.getElementById('statusFilter').value;
        const subjectFilter = document.getElementById('subjectFilter').value;

        let allJobs = await Qbank.fetchGenerationJobs();

        // Filter by status
        if (statusFilter !== 'all') {
          allJobs = allJobs.filter(j => j.status === statusFilter);
        }

        // Filter by subject
        if (subjectFilter !== 'all') {
          allJobs = allJobs.filter(j => j.subject_id === subjectFilter);
        }

        jobs = allJobs;

        if (jobs.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p class="empty-title">No jobs found</p>
              <p class="empty-message">No generation jobs match the current filters</p>
              ${user.role === 'admin' ? '<a href="./generate.html" class="btn btn-primary">Generate Questions</a>' : ''}
            </div>
          `;
          return;
        }

        container.innerHTML = jobs.map((job, jobIndex) => renderJobCard(job, jobIndex)).join('');

      } catch (error) {
        console.error('Error loading jobs:', error);
        container.innerHTML = '<p class="empty-message">Failed to load review queue</p>';
      }
    }

    function renderJobCard(job, jobIndex) {
      const questions = job.output_json?.questions || [];
      const subjectColor = Qbank.getSubjectColor(job.subject_id);

      return `
        <div class="job-card" id="job-${job.id}">
          <div class="job-header" onclick="toggleJob('${job.id}')">
            <div class="job-info">
              <div class="job-subject-icon" style="background: ${subjectColor}15; color: ${subjectColor};">
                ${Qbank.getSubjectEmoji(job.subject_id)}
              </div>
              <div class="job-details">
                <h4>${job.subject_id} - ${job.chapter_id || 'Unknown Chapter'}</h4>
                <div class="job-meta">
                  ${questions.length} questions ‚Ä¢ Generated ${Qbank.formatDate(job.created_at)}
                </div>
              </div>
            </div>
            <div class="job-actions">
              ${Qbank.getStatusBadge(job.status)}
              <span style="font-size: 1.2rem; color: var(--gray-400);">‚ñº</span>
            </div>
          </div>

          <div class="job-content" id="job-content-${job.id}">
            ${questions.length > 0 ? `
              <div class="bulk-actions">
                <div class="select-all-wrapper">
                  <input type="checkbox" id="selectAll-${job.id}" onchange="toggleSelectAll('${job.id}')">
                  <label for="selectAll-${job.id}">Select All</label>
                </div>
                <span style="color: var(--gray-400);">|</span>
                <button class="btn btn-sm btn-success" onclick="approveSelected('${job.id}')">
                  ‚úì Approve Selected
                </button>
                <button class="btn btn-sm btn-danger" onclick="rejectSelected('${job.id}')">
                  ‚úï Reject Selected
                </button>
                ${user.role === 'admin' ? `
                  <button class="btn btn-sm btn-primary" onclick="markAsReviewed('${job.id}')">
                    üìù Mark Job as Reviewed
                  </button>
                ` : ''}
              </div>

              <div class="questions-list">
                ${questions.map((q, qIndex) => renderQuestionReview(job, q, qIndex)).join('')}
              </div>
            ` : '<p class="empty-message" style="padding: 20px;">No questions in this job</p>'}
          </div>
        </div>
      `;
    }

    function renderQuestionReview(job, question, index) {
      const isApproved = question._approved === true;
      const isRejected = question._rejected === true;

      let statusClass = '';
      if (isApproved) statusClass = 'style="border-left: 4px solid var(--success);"';
      if (isRejected) statusClass = 'style="border-left: 4px solid var(--error); opacity: 0.6;"';

      const options = question.options ? question.options.map(opt => `
        <div class="option-item ${opt.is_correct ? 'correct' : ''}">
          <span class="option-key">${opt.key}</span>
          <span class="option-text">${opt.text}</span>
        </div>
      `).join('') : '';

      const hints = question.elimination_hints ? `
        <div class="elimination-hints">
          <strong style="font-size: 0.85rem; color: var(--gray-600);">Elimination Hints:</strong>
          ${question.elimination_hints.map(h => `
            <div class="hint-item">
              <span class="hint-key">${h.option_key}:</span>
              <span>${h.hint}</span>
            </div>
          `).join('')}
        </div>
      ` : '';

      return `
        <div class="question-card" ${statusClass} id="q-${job.id}-${index}">
          <div class="question-header">
            <div class="question-meta">
              <div class="question-checkbox">
                <input type="checkbox" class="question-select" data-job="${job.id}" data-index="${index}"
                       ${isApproved || isRejected ? 'disabled' : ''}>
              </div>
              <span class="question-number">Q${index + 1}</span>
              ${Qbank.getQuestionTypeBadge(question.question_type)}
              ${Qbank.getDifficultyBadge(question.difficulty)}
              ${question.topic ? `<span class="badge badge-type">${question.topic}</span>` : ''}
              ${isApproved ? '<span class="badge badge-approved">Approved</span>' : ''}
              ${isRejected ? '<span class="badge badge-rejected">Rejected</span>' : ''}
            </div>
            <div class="question-actions">
              <button class="btn btn-sm btn-ghost question-edit-btn" onclick="editQuestion('${job.id}', ${index})">
                ‚úèÔ∏è Edit
              </button>
            </div>
          </div>
          <div class="question-body">
            <p class="question-text">${question.question_text}</p>
            ${options ? `<div class="question-options">${options}</div>` : ''}
            ${question.explanation ? `
              <div class="question-explanation">
                <div class="explanation-title">Explanation</div>
                <p style="margin: 0;">${question.explanation}</p>
                ${hints}
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function toggleJob(jobId) {
      const content = document.getElementById(`job-content-${jobId}`);
      content.classList.toggle('expanded');
    }

    function toggleSelectAll(jobId) {
      const selectAll = document.getElementById(`selectAll-${jobId}`);
      const checkboxes = document.querySelectorAll(`.question-select[data-job="${jobId}"]:not(:disabled)`);
      checkboxes.forEach(cb => cb.checked = selectAll.checked);
    }

    function getSelectedQuestions(jobId) {
      const checkboxes = document.querySelectorAll(`.question-select[data-job="${jobId}"]:checked`);
      return Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));
    }

    async function approveSelected(jobId) {
      const indices = getSelectedQuestions(jobId);
      if (indices.length === 0) {
        Qbank.showToast('No questions selected', 'warning');
        return;
      }

      const job = jobs.find(j => j.id === jobId);
      if (!job) return;

      indices.forEach(i => {
        job.output_json.questions[i]._approved = true;
        job.output_json.questions[i]._rejected = false;
      });

      await Qbank.updateGenerationJob(jobId, { output_json: job.output_json });
      Qbank.showToast(`${indices.length} questions approved`, 'success');
      loadJobs();
    }

    async function rejectSelected(jobId) {
      const indices = getSelectedQuestions(jobId);
      if (indices.length === 0) {
        Qbank.showToast('No questions selected', 'warning');
        return;
      }

      const job = jobs.find(j => j.id === jobId);
      if (!job) return;

      indices.forEach(i => {
        job.output_json.questions[i]._approved = false;
        job.output_json.questions[i]._rejected = true;
      });

      await Qbank.updateGenerationJob(jobId, { output_json: job.output_json });
      Qbank.showToast(`${indices.length} questions rejected`, 'success');
      loadJobs();
    }

    async function markAsReviewed(jobId) {
      const job = jobs.find(j => j.id === jobId);
      if (!job) return;

      const approvedQuestions = job.output_json.questions.filter(q => q._approved);
      const approvedCount = approvedQuestions.length;

      if (approvedCount === 0) {
        Qbank.showToast('Please approve at least one question first', 'warning');
        return;
      }

      // Confirm before inserting
      if (!confirm(`Insert ${approvedCount} approved questions to database?\n\n(${job.output_json.questions.length - approvedCount} rejected questions will be discarded)`)) {
        return;
      }

      Qbank.showToast('Inserting approved questions to database...', 'info');

      // Insert only approved questions to DB
      const result = await Qbank.insertApprovedQuestionsToDb(job, approvedQuestions);

      if (result.success) {
        Qbank.showToast(`‚úÖ Inserted ${result.insertedCount} questions to database`, 'success');
        loadJobs();
      } else {
        Qbank.showToast(`Error: ${result.error}`, 'error');
      }
    }

    // ========================================================================
    // EDIT MODAL
    // ========================================================================
    function editQuestion(jobId, index) {
      const job = jobs.find(j => j.id === jobId);
      if (!job) return;

      currentEditJob = job;
      currentEditIndex = index;

      const question = job.output_json.questions[index];

      const optionsHtml = question.options ? question.options.map((opt, i) => `
        <div class="option-edit-row">
          <span style="width: 30px; font-weight: 600;">${opt.key}.</span>
          <input type="text" id="editOpt${i}" value="${escapeHtml(opt.text)}" style="flex: 1;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="radio" name="correctOption" value="${i}" ${opt.is_correct ? 'checked' : ''}>
            Correct
          </label>
        </div>
      `).join('') : '';

      document.getElementById('editModalBody').innerHTML = `
        <div class="form-group">
          <label class="form-label">Question Text</label>
          <textarea id="editQuestionText">${escapeHtml(question.question_text)}</textarea>
        </div>

        ${question.options ? `
          <div class="form-group">
            <label class="form-label">Options</label>
            ${optionsHtml}
          </div>
        ` : ''}

        <div class="form-group">
          <label class="form-label">Explanation</label>
          <textarea id="editExplanation">${escapeHtml(question.explanation || '')}</textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Difficulty</label>
            <select id="editDifficulty" class="form-select">
              <option value="easy" ${question.difficulty === 'easy' ? 'selected' : ''}>Easy</option>
              <option value="medium" ${question.difficulty === 'medium' ? 'selected' : ''}>Medium</option>
              <option value="hard" ${question.difficulty === 'hard' ? 'selected' : ''}>Hard</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Topic</label>
            <input type="text" id="editTopic" class="form-input" value="${escapeHtml(question.topic || '')}">
          </div>
        </div>
      `;

      const modal = document.getElementById('editModal');
      modal.style.display = 'flex';
      requestAnimationFrame(() => modal.classList.add('show'));
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      modal.classList.remove('show');
      setTimeout(() => modal.style.display = 'none', 300);
      currentEditJob = null;
      currentEditIndex = null;
    }

    async function saveQuestionEdit() {
      if (!currentEditJob || currentEditIndex === null) return;

      const question = currentEditJob.output_json.questions[currentEditIndex];

      // Update question data
      question.question_text = document.getElementById('editQuestionText').value;
      question.explanation = document.getElementById('editExplanation').value;
      question.difficulty = document.getElementById('editDifficulty').value;
      question.topic = document.getElementById('editTopic').value;

      // Update options if present
      if (question.options) {
        const correctIndex = parseInt(document.querySelector('input[name="correctOption"]:checked')?.value ?? 0);
        question.options.forEach((opt, i) => {
          opt.text = document.getElementById(`editOpt${i}`).value;
          opt.is_correct = i === correctIndex;
        });
        question.correct_answer = question.options[correctIndex].key;
      }

      // Save to database
      try {
        await Qbank.updateGenerationJob(currentEditJob.id, {
          output_json: currentEditJob.output_json
        });
        Qbank.showToast('Question updated successfully', 'success');
        closeEditModal();
        loadJobs();
      } catch (error) {
        console.error('Error saving question:', error);
        Qbank.showToast('Failed to save changes', 'error');
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    init();
  </script>
</body>
</html>
